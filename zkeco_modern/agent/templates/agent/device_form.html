{% extends 'agent/base_legacy.html' %}
{% block title %}{% if obj %}EditeazƒÉ Dispozitiv{% else %}Dispozitiv Nou{% endif %}{% endblock %}
{% block content %}
<style>
.device-form-container { max-width: 1000px; margin: 20px auto; }
.form-section { background: white; border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 4px; }
.form-section h3 { font-size: 14px; font-weight: bold; border-bottom: 2px solid #0066cc; padding-bottom: 8px; margin: 0 0 15px 0; color: #0066cc; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
.form-row.full { grid-template-columns: 1fr; }
.form-group { display: flex; flex-direction: column; }
.form-group label { font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #333; }
.form-group .helptext { font-size: 11px; color: #999; margin-top: 3px; }
input[type="text"], input[type="number"], input[type="password"], select { 
  padding: 8px 10px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; background: white;
}
input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, select:focus { 
  outline: none; border-color: #0066cc; box-shadow: 0 0 3px #0066cc;
}
input[readonly] { background: #f5f5f5; color: #666; }
.radio-options { display: flex; gap: 30px; margin: 10px 0; }
.radio-options label { display: flex; align-items: center; gap: 8px; font-weight: normal; margin: 0; }
.radio-options input { margin: 0; }
.checkbox-options { display: flex; flex-direction: column; gap: 8px; }
.checkbox-options label { display: flex; align-items: center; gap: 8px; font-weight: normal; margin: 0; }
.checkbox-options input { margin: 0; }
.discovery-section { background: #f0f8ff; border: 1px solid #0066cc; padding: 15px; margin: 20px 0; border-radius: 4px; }
.discovery-section strong { color: #0066cc; }
.discovery-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin: 10px 0; align-items: flex-end; }
.discovery-row input { padding: 6px 8px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
.btn-scan { background: #0066cc; color: white; border: none; padding: 6px 14px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 12px; }
.btn-scan:hover { background: #0052a3; }
.results-box { margin-top: 10px; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 3px; max-height: 120px; overflow-y: auto; font-size: 12px; }
.ip-item { display: inline-block; margin: 4px; padding: 4px 8px; background: #e8f4f8; border: 1px solid #0066cc; border-radius: 3px; cursor: pointer; color: #0066cc; }
.ip-item:hover { background: #d0e8f0; }
.form-errors { background: #fee; border: 1px solid #fcc; color: #c00; padding: 12px; margin: 15px 0; border-radius: 3px; }
.form-errors ul { margin: 5px 0; padding-left: 20px; }
.form-errors li { margin: 3px 0; }
.button-group { display: flex; gap: 10px; margin-top: 25px; }
.btn-save { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; }
.btn-save:hover { background: #218838; }
.btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; text-decoration: none; display: inline-block; }
.btn-cancel:hover { background: #5a6268; }
.required::after { content: " *"; color: red; font-weight: bold; }
</style>

<div class="device-form-container">
<h2>{% if obj %}‚úèÔ∏è EditeazƒÉ Dispozitiv{% else %}‚ûï Dispozitiv Nou{% endif %}</h2>

{% if form.non_field_errors %}
<div class="form-errors">
  <strong>‚ö†Ô∏è Erori:</strong>
  <ul>
  {% for error in form.non_field_errors %}
    <li>{{ error }}</li>
  {% endfor %}
  </ul>
</div>
{% endif %}

<form method="post" novalidate>{% csrf_token %}

<!-- SECTION 1: BASIC INFORMATION -->
<div class="form-section">
  <h3>1. Informa»õii de BazƒÉ</h3>
  
  <div class="form-row">
    <div class="form-group">
      <label for="{{ form.name.id_for_label }}" class="required">Nume Dispozitiv</label>
      {{ form.name }}
      {% if form.name.errors %}<span class="form-errors">{{ form.name.errors|join:", " }}</span>{% endif %}
      <div class="helptext">Exemplu: FINANCIAR, MEDICAL ACCES CLUB, etc.</div>
    </div>
    <div class="form-group">
      <label for="{{ form.serial_number.id_for_label }}">NumƒÉr Serie (SN)</label>
      {{ form.serial_number }}
      {% if form.serial_number.errors %}<span class="form-errors">{{ form.serial_number.errors|join:", " }}</span>{% endif %}
      <div class="helptext">Auto-completat din descoperire</div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="{{ form.device_type.id_for_label }}" class="required">Tip Dispozitiv</label>
      {{ form.device_type }}
      {% if form.device_type.errors %}<span class="form-errors">{{ form.device_type.errors|join:", " }}</span>{% endif %}
    </div>
    <div class="form-group">
      <label>Stare</label>
      <div class="checkbox-options">
        <label>
          {{ form.enabled }}
          <span>Activ (Enabled)</span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- SECTION 2: COMMUNICATION SETTINGS -->
<div class="form-section">
  <h3>2. Parametri de Comunicare</h3>
  
  <div class="form-row full">
    <div class="form-group">
      <label class="required">Mod de Comunicare</label>
      <div class="radio-options">
        <label>
          <input type="radio" name="comm_mode" value="tcp" checked onchange="toggleCommMode()">
          TCP/IP
        </label>
        <label>
          <input type="radio" name="comm_mode" value="rs485" onchange="toggleCommMode()">
          RS485
        </label>
      </div>
    </div>
  </div>

  <!-- TCP/IP Fields -->
  <div id="tcp-group">
    <div class="form-row">
      <div class="form-group">
        <label for="{{ form.ip_address.id_for_label }}" class="required">AdresƒÉ IP</label>
        {{ form.ip_address }}
        {% if form.ip_address.errors %}<span class="form-errors">{{ form.ip_address.errors|join:", " }}</span>{% endif %}
        <div class="helptext">Exemplu: 192.168.1.100</div>
      </div>
      <div class="form-group">
        <label for="{{ form.port.id_for_label }}">Port</label>
        {{ form.port }}
        {% if form.port.errors %}<span class="form-errors">{{ form.port.errors|join:", " }}</span>{% endif %}
        <div class="helptext">Implicit: 4370</div>
      </div>
    </div>
  </div>

  <!-- RS485 Fields -->
  <div id="rs485-group" style="display: none;">
    <div class="form-row">
      <div class="form-group">
        <label for="{{ form.rs485_port.id_for_label }}">Port Serial</label>
        {{ form.rs485_port }}
        {% if form.rs485_port.errors %}<span class="form-errors">{{ form.rs485_port.errors|join:", " }}</span>{% endif %}
        <div class="helptext">COM1, COM2, /dev/ttyUSB0</div>
      </div>
      <div class="form-group">
        <label for="{{ form.rs485_baudrate.id_for_label }}">Baud Rate</label>
        {{ form.rs485_baudrate }}
        {% if form.rs485_baudrate.errors %}<span class="form-errors">{{ form.rs485_baudrate.errors|join:", " }}</span>{% endif %}
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="{{ form.rs485_address.id_for_label }}">AdresƒÉ Dispozitiv</label>
        {{ form.rs485_address }}
        {% if form.rs485_address.errors %}<span class="form-errors">{{ form.rs485_address.errors|join:", " }}</span>{% endif %}
        <div class="helptext">AdresƒÉ pe magistrala RS485</div>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label for="{{ form.comm_password.id_for_label }}">ParolƒÉ Comunicare</label>
      {{ form.comm_password }}
      {% if form.comm_password.errors %}<span class="form-errors">{{ form.comm_password.errors|join:", " }}</span>{% endif %}
      <div class="helptext">Op»õional - pentru dispozitive cu autentificare</div>
    </div>
  </div>
</div>

<!-- SECTION 3: LOCATION & CONFIGURATION -->
<div class="form-section">
  <h3>3. Loca»õie »ôi Configurare</h3>
  
  <div class="form-row">
    <div class="form-group">
      <label for="{{ form.area_name.id_for_label }}">ZonƒÉ / Loca»õie</label>
      {{ form.area_name }}
      {% if form.area_name.errors %}<span class="form-errors">{{ form.area_name.errors|join:", " }}</span>{% endif %}
      <div class="helptext">Exemplu: Intrare PrincipalƒÉ, Birou Director, etc.</div>
    </div>
    <div class="form-group">
      <label for="{{ form.time_zone.id_for_label }}">Fus Orar</label>
      {{ form.time_zone }}
      {% if form.time_zone.errors %}<span class="form-errors">{{ form.time_zone.errors|join:", " }}</span>{% endif %}
      <div class="helptext">UTC+2, UTC+3, etc.</div>
    </div>
  </div>

  <div class="form-row full">
    <div class="form-group">
      <label>Op»õiuni</label>
      <div class="checkbox-options">
        <label>
          {{ form.auto_sync_time }}
          <span>Sincronizare AutomatƒÉ a Orei</span>
        </label>
        <label>
          {{ form.clear_on_add }}
          <span>»òterge Datele din Dispozitiv la AdƒÉugare</span>
        </label>
      </div>
    </div>
  </div>
</div>

<!-- SECTION 4: TECHNICAL INFORMATION -->
<div class="form-section">
  <h3>4. Informa»õii Tehnice</h3>
  
  <div class="form-row">
    <div class="form-group">
      <label for="{{ form.firmware_version.id_for_label }}">Versiune Firmware</label>
      {{ form.firmware_version }}
      <div class="helptext">Auto-detectatƒÉ din descoperire</div>
    </div>
    <div class="form-group">
      <label for="{{ form.hardware_version.id_for_label }}">Versiune Hardware</label>
      {{ form.hardware_version }}
    </div>
  </div>
</div>

<!-- SECTION 5: DISCOVERY & TESTING -->
<div class="discovery-section">
  <strong>üîç Descoperire »ôi Testare Dispozitiv</strong>
  
  <div class="discovery-row">
    <div>
      <label for="netBase">Prefix Re»õea (e.g. 192.168.1):</label>
      <input type="text" id="netBase" value="192.168.1" placeholder="192.168.1" />
    </div>
    <button type="button" class="btn-scan" onclick="discoverDevices()">üîé ScaneazƒÉ Re»õea</button>
  </div>
  
  <div class="discovery-row">
    <div>
      <label for="pingIp">Test IP (ping):</label>
      <input type="text" id="pingIp" placeholder="192.168.1.100" />
    </div>
    <button type="button" class="btn-scan" onclick="pingDevice()">üì° Ping</button>
  </div>
  
  <div id="netResults" class="results-box" style="display: none;"></div>
</div>

<!-- BUTTONS -->
<div class="button-group">
  <button type="submit" class="btn-save">üíæ SalveazƒÉ Dispozitiv</button>
  <a href="{% url 'crud-devices-list' %}" class="btn-cancel">‚ùå AnuleazƒÉ</a>
</div>

</form>
</div>

<script>
function toggleCommMode() {
  const mode = document.querySelector('input[name="comm_mode"]:checked').value;
  document.getElementById('tcp-group').style.display = (mode === 'tcp') ? 'block' : 'none';
  document.getElementById('rs485-group').style.display = (mode === 'rs485') ? 'block' : 'none';
}

async function discoverDevices() {
  const base = document.getElementById('netBase').value.trim();
  if (!base) { alert('Introdu prefixul re»õelei'); return; }
  
  const resultsDiv = document.getElementById('netResults');
  resultsDiv.style.display = 'block';
  resultsDiv.textContent = '‚è≥ Scanare √Æn curs...';
  
  try {
    const resp = await fetch(`/agent/devices/discover/?base=${encodeURIComponent(base)}`);
    const data = await resp.json();
    
    if (data.ok && data.responsive.length > 0) {
      let html = '<strong>üü¢ Dispozitive gƒÉsite:</strong><br>';
      data.responsive.forEach(ip => {
        html += `<div class="ip-item" onclick="selectIP('${ip}')">${ip}</div> `;
      });
      resultsDiv.innerHTML = html;
    } else {
      resultsDiv.textContent = '‚ùå Nicio adresƒÉ receptivƒÉ';
    }
  } catch (e) {
    resultsDiv.textContent = '‚ùå Eroare: ' + e.message;
  }
}

async function pingDevice() {
  const ip = document.getElementById('pingIp').value.trim();
  if (!ip) { alert('Introdu o adresƒÉ IP'); return; }
  
  const resultsDiv = document.getElementById('netResults');
  resultsDiv.style.display = 'block';
  resultsDiv.textContent = '‚è≥ Ping...';
  
  try {
    const resp = await fetch(`/agent/devices/ping/?ip=${encodeURIComponent(ip)}`);
    const data = await resp.json();
    
    if (data.ok) {
      resultsDiv.innerHTML = data.alive 
        ? `üü¢ <strong>${ip} ONLINE</strong> | <div class="ip-item" onclick="selectIP('${ip}')">SelecteazƒÉ IP</div>`
        : `üî¥ ${ip} NU RƒÇSPUNDE`;
    } else {
      resultsDiv.textContent = '‚ùå Eroare ping';
    }
  } catch (e) {
    resultsDiv.textContent = '‚ùå Eroare: ' + e.message;
  }
}

function selectIP(ip) {
  document.getElementById('{{ form.ip_address.id_for_label|slice:"3:" }}').value = ip;
}

window.addEventListener('DOMContentLoaded', toggleCommMode);
</script>
{% endblock %}
