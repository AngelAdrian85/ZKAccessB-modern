{% extends 'agent/base_legacy.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
.dashboard-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
@media (max-width: 1400px) { .dashboard-row { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 1000px) { .dashboard-row { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .dashboard-row { grid-template-columns: 1fr; } }
.panel { padding: 12px !important; }
.panel h2 { margin: 0 0 8px 0; font-size: 13px; }
.panel h3 { margin: 8px 0 6px 0; font-size: 11px; }
table { font-size: 10px; }
table th, table td { padding: 4px 6px; }
.metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; line-height: 1.4; }
.op { padding: 4px 8px; font-size: 10px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
.modal.show { display: flex; align-items: center; justify-content: center; }
.modal-content { background: #2d5a7b; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; border: 2px solid #3da5d9; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid #3da5d9; padding-bottom: 8px; }
.modal-header h2 { margin: 0; font-size: 16px; color: #3da5d9; }
.modal-close { background: none; border: none; color: #e8f0f8; font-size: 20px; cursor: pointer; }
.modal-body { color: #e8f0f8; font-size: 11px; line-height: 1.6; }
.modal-body ol { margin: 0; padding-left: 20px; }
.modal-body li { margin-bottom: 4px; }
.modal-footer { margin-top: 12px; text-align: right; }
.modal-footer button { padding: 6px 12px; background: #3da5d9; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; }
</style>

<!-- ROW 1: SYSTEM STATUS COMPACT -->
<div class="dashboard-row">
  <section class="panel accent">
    <h2>ğŸ“Š System Summary</h2>
    <div class="metrics">
      <div><strong>Devices:</strong> {{ counts.devices }} ğŸŸ¢{{ counts.online_devices }}</div>
      <div><strong>Doors:</strong> {{ counts.doors }} ğŸ”“{{ counts.open_doors }}</div>
      <div><strong>Employees:</strong> {{ counts.employees }}</div>
      <div><strong>Access Lvl:</strong> {{ counts.access_levels }}</div>
      <div><strong>Time Seg:</strong> {{ counts.time_segments }}</div>
      <div><strong>Holidays:</strong> {{ counts.holidays }}</div>
      <div><strong>Pending:</strong> {{ counts.pending_commands }}</div>
      <div><strong>Cache:</strong> {{ counts.cache_entries }}</div>
    </div>
  </section>

  <section class="panel">
    <h2>âš™ï¸ Quick Actions</h2>
    <ul style="list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
      <li><a href="#" onclick="openQuickAddEmployee(); return false;" class="op">â• Person</a></li>
      <li><a href="#" onclick="openQuickAddDevice(); return false;" class="op">â• Device</a></li>
      <li><a href="{% url 'crud-dept-create' %}" class="op">â• Dept</a></li>
      <li><a href="{% url 'agent-monitor' %}" class="op">ğŸ”´ Monitor</a></li>
      <li><a href="{% url 'crud-access-logs-list' %}" class="op">ğŸ“‹ Logs</a></li>
      <li><a href="{% url 'agent-report-alarms' %}" class="op">ğŸ“Š Reports</a></li>
      <li><a href="{% url 'agent-control-center' %}" class="op" style="background: #2da44e; font-weight: 600;">ğŸ® Control</a></li>
      <li><a href="{% url 'crud-employee-create' %}" class="op">ğŸ‘† Biometric</a></li>
    </ul>
  </section>

  <section class="panel">
    <h2>ğŸ”— System Health</h2>
    <div style="display: flex; flex-direction: column; gap: 5px; font-size: 11px;">
      <div style="display: flex; justify-content: space-between;">
        <span>Server</span>
        <span id="djangoStatus" style="color: #2da44e;">âœ“ Running</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>Database</span>
        <span id="dbStatus" style="color: #2da44e;">âœ“ Connected</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>WebSocket</span>
        <span id="wsConnStatus" style="color: #d97e4a;">âŸ³ Pending</span>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>ğŸ“– Guides</h2>
    <button onclick="openGetStartedModal()" style="background: #3da5d9; color: #fff; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 11px; font-weight: 600; margin-bottom: 8px;">ğŸ“š Get Started</button>
    <button onclick="openQuickStartModal()" style="background: #3da5d9; color: #fff; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 11px; font-weight: 600;">âš¡ Quick Start</button>
  </section>
</div>

<!-- ROW 2: LIVE STATUS & EVENTS -->
<div class="dashboard-row" style="grid-template-columns: 1fr 1fr;">
  <section class="panel accent">
    <h2>ğŸ“ Live Status</h2>
    <h3>Devices</h3>
    <table style="width: 100%; margin-bottom: 12px;">
      <thead>
        <tr><th>Device</th><th>Status</th><th>Updated</th></tr>
      </thead>
      <tbody>
      {% for ds in device_statuses %}
        <tr><td>{{ ds.device__name|truncatewords:2 }}</td>
          <td>{% if ds.online %}<span style="color: #2da44e;">ğŸŸ¢</span>{% else %}<span style="color: #d97e4a;">ğŸ”´</span>{% endif %}</td>
          <td>{{ ds.updated_at|date:"H:i" }}</td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90;">No data</td></tr>
      {% endfor %}
      </tbody>
    </table>
    <h3>Doors</h3>
    <table style="width: 100%;">
      <thead>
        <tr><th>Door</th><th>Status</th><th>Action</th></tr>
      </thead>
      <tbody>
      {% for door in doors %}
        <tr><td>{{ door.name|truncatewords:2 }}</td>
          <td>{% if door.is_open %}<span style="color: #3da5d9;">ğŸ”“</span>{% else %}<span style="color: #7db3d9;">ğŸ”’</span>{% endif %}</td>
          <td><button onclick="doorAction({{ door.id }}, 'open')" style="padding: 2px 4px; font-size: 9px; background: #3da5d9; border: none; border-radius: 2px; cursor: pointer; color: #fff;">â–¶</button></td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90;">No doors</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="panel">
    <h2>â±ï¸ Recent Events</h2>
    <div id="eventsContainer" style="max-height: 280px; overflow-y: auto; font-size: 10px; color: #e8f0f8;">
      <div style="padding: 10px; text-align: center; color: #5a7a90;">No events</div>
    </div>
  </section>
</div>

<!-- ROW 3: COMMANDS -->
<div class="dashboard-row" style="grid-template-columns: 1fr;">
  <section class="panel">
    <h2>ğŸ”§ Recent Commands</h2>
    <table style="width: 100%;">
      <thead>
        <tr><th>Time</th><th>Command</th><th>Status</th></tr>
      </thead>
      <tbody>
      {% for c in recent_commands %}
        <tr><td>{{ c.created_at|date:"H:i" }}</td>
          <td>{{ c.command|truncatewords:5 }}</td>
          <td style="text-align: center; color: #3da5d9;">{{ c.status }}</td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90; padding: 10px;">No commands</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- MODALS -->
<div id="getStartedModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ“š Get Started</h2>
      <button class="modal-close" onclick="closeGetStartedModal()">&times;</button>
    </div>
    <div class="modal-body">
      <ol><li>Add devices</li><li>Add employees</li><li>Set access levels</li><li>Assign permissions</li><li>Configure doors</li><li>Test access</li><li>Monitor logs</li><li>View reports</li></ol>
    </div>
  </div>
</div>

<div id="quickStartModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>âš¡ Quick Start</h2>
      <button class="modal-close" onclick="closeQuickStartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <ol><li>Discover devices</li><li>Add employee</li><li>Register biometric</li><li>Create access level</li><li>Assign access</li><li>Test door</li><li>Check logs</li><li>Generate report</li></ol>
    </div>
  </div>
</div>

<script>
function openGetStartedModal() { document.getElementById('getStartedModal').classList.add('show'); }
function closeGetStartedModal() { document.getElementById('getStartedModal').classList.remove('show'); }
function openQuickStartModal() { document.getElementById('quickStartModal').classList.add('show'); }
function closeQuickStartModal() { document.getElementById('quickStartModal').classList.remove('show'); }
function openQuickAddEmployee() { console.log('Add employee'); }
function openQuickAddDevice() { console.log('Add device'); }
function doorAction(doorId, action) { console.log('Door ' + doorId + ' - ' + action); }
window.onclick = function(event) {
  let getModal = document.getElementById('getStartedModal');
  let quickModal = document.getElementById('quickStartModal');
  if (event.target == getModal) getModal.classList.remove('show');
  if (event.target == quickModal) quickModal.classList.remove('show');
}
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('wsConnStatus').innerText = 'âœ“ Connected';
});
</script>

{% endblock %}
