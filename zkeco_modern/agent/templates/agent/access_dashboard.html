{% extends 'agent/base_legacy.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
.dashboard-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
@media (max-width: 1400px) { .dashboard-row { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 1000px) { .dashboard-row { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 768px) { .dashboard-row { grid-template-columns: 1fr; } }
.panel { padding: 12px !important; }
.panel h2 { margin: 0 0 8px 0; font-size: 13px; }
.panel h3 { margin: 8px 0 6px 0; font-size: 11px; }
table { font-size: 10px; }
table th, table td { padding: 4px 6px; }
.metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; line-height: 1.4; }
.op { padding: 4px 8px; font-size: 10px; }
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
.modal.show { display: flex; align-items: center; justify-content: center; }
/* Outer blue frame matching legacy admin modal */
.modal-content { width: 90%; max-width: 1200px; padding: 8px; border-radius: 10px; background: linear-gradient(#5c95b8, #2f5f80); border: 2px solid #3b7fa3; box-shadow: 0 8px 22px rgba(0,0,0,0.45); position: relative; }
/* Inner white panel that contains the title bar, body and footer */
.modal-inner { background: #fff; border-radius: 6px; overflow: hidden; border: 3px solid #a8def4; }
.modal-titlebar { background: linear-gradient(#eaf6fc,#dff3fb); padding: 8px 12px; border-bottom: 1px solid #cfeaf8; font-weight:700; color:#234e6c; font-size:13px; }
.modal-titlebar { background: linear-gradient(#eaf6fc,#dff3fb); padding: 8px 14px; border-bottom: 1px solid #bfe8f6; font-weight:700; color:#234e6c; font-size:13px; }
  .modal-titlebar .title { display:flex; align-items:center; gap:8px; }
.modal-titlebar .icon { width:18px; height:18px; background:#3da5d9; color:#fff; display:inline-flex; align-items:center; justify-content:center; border-radius:3px; font-weight:700; font-size:12px; }
  .modal-body { color: #0b1720; font-size: 12px; line-height: 1.5; padding: 18px 22px; max-height: 70vh; overflow: auto; background: #fff; }
  .modal-footer { padding: 10px 16px; text-align: right; border-top: 1px solid #e6f3f9; background: #fff; }
  .modal-footer button { padding: 6px 10px; background: #f3f5f7; color: #2b6b8d; border: 1px solid #d0e6f3; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .modal-footer button.primary { background:#3da5d9;color:#fff;border:1px solid #2f86ad; }
  /* Close button overlapping the outer frame */
  .modal-close { position: absolute; right: 18px; top: -16px; width:30px; height:30px; border-radius:50%; background:#fff; border:2px solid #3da5d9; color:#2b6b8d; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.25); font-weight:700; }
</style>

<!-- ROW 1: SYSTEM STATUS COMPACT -->
<div class="dashboard-row">
  <section class="panel accent">
    <h2>üìä System Summary</h2>
    <div class="metrics">
      <div><strong>Devices:</strong> {{ counts.devices }} üü¢{{ counts.online_devices }}</div>
      <div><strong>Doors:</strong> {{ counts.doors }} üîì{{ counts.open_doors }}</div>
      <div><strong>Employees:</strong> {{ counts.employees }}</div>
      <div><strong>Access Lvl:</strong> {{ counts.access_levels }}</div>
      <div><strong>Time Seg:</strong> {{ counts.time_segments }}</div>
      <div><strong>Holidays:</strong> {{ counts.holidays }}</div>
      <div><strong>Pending:</strong> {{ counts.pending_commands }}</div>
      <div><strong>Cache:</strong> {{ counts.cache_entries }}</div>
    </div>
  </section>

  <section class="panel">
    <h2>‚öôÔ∏è Quick Actions</h2>
    <ul style="list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
      <li><a href="#" onclick="openQuickAddEmployee(); return false;" class="op">‚ûï Person</a></li>
      <li><a href="#" onclick="openQuickAddDevice(); return false;" class="op">‚ûï Device</a></li>
      <li><a href="{% url 'crud-dept-create' %}" class="op">‚ûï Dept</a></li>
      <li><a href="{% url 'agent-monitor' %}" class="op">üî¥ Monitor</a></li>
      <li><a href="{% url 'crud-access-logs-list' %}" class="op">üìã Logs</a></li>
      <li><a href="{% url 'agent-report-alarms' %}" class="op">üìä Reports</a></li>
      <li><a href="{% url 'agent-control-center' %}" class="op" style="background: #2da44e; font-weight: 600;">üéÆ Control</a></li>
      <li><a href="{% url 'crud-employee-create' %}" class="op">üëÜ Biometric</a></li>
    </ul>
  </section>

  <section class="panel">
    <h2>üîó System Health</h2>
    <div style="display: flex; flex-direction: column; gap: 5px; font-size: 11px;">
      <div style="display: flex; justify-content: space-between;">
        <span>Server</span>
        <span id="djangoStatus" style="color: #2da44e;">‚úì Running</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>Database</span>
        <span id="dbStatus" style="color: #2da44e;">‚úì Connected</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span>WebSocket</span>
        <span id="wsConnStatus" style="color: #d97e4a;">‚ü≥ Pending</span>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>üìñ Guides</h2>
    <button onclick="openGetStartedModal()" style="background: #3da5d9; color: #fff; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 11px; font-weight: 600; margin-bottom: 8px;">üìö Get Started</button>
    <button onclick="openQuickStartModal()" style="background: #3da5d9; color: #fff; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 11px; font-weight: 600;">‚ö° Quick Start</button>
  </section>
</div>

<!-- ROW 2: LIVE STATUS & EVENTS -->
<div class="dashboard-row" style="grid-template-columns: 1fr 1fr;">
  <section class="panel accent">
    <h2>üìç Live Status</h2>
    <h3>Devices</h3>
    <table style="width: 100%; margin-bottom: 12px;">
      <thead>
        <tr><th>Device</th><th>Status</th><th>Updated</th></tr>
      </thead>
      <tbody>
      {% for ds in device_statuses %}
        <tr><td>{{ ds.device__name|truncatewords:2 }}</td>
          <td>{% if ds.online %}<span style="color: #2da44e;">üü¢</span>{% else %}<span style="color: #d97e4a;">üî¥</span>{% endif %}</td>
          <td>{{ ds.updated_at|date:"H:i" }}</td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90;">No data</td></tr>
      {% endfor %}
      </tbody>
    </table>
    <h3>Doors</h3>
    <table style="width: 100%;">
      <thead>
        <tr><th>Door</th><th>Status</th><th>Action</th></tr>
      </thead>
      <tbody>
      {% for door in doors %}
        <tr><td>{{ door.name|truncatewords:2 }}</td>
          <td>{% if door.is_open %}<span style="color: #3da5d9;">üîì</span>{% else %}<span style="color: #7db3d9;">üîí</span>{% endif %}</td>
          <td><button onclick="doorAction({{ door.id }}, 'open')" style="padding: 2px 4px; font-size: 9px; background: #3da5d9; border: none; border-radius: 2px; cursor: pointer; color: #fff;">‚ñ∂</button></td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90;">No doors</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <section class="panel">
    <h2>‚è±Ô∏è Recent Events</h2>
    <div id="eventsContainer" style="max-height: 280px; overflow-y: auto; font-size: 10px; color: #e8f0f8;">
      <div style="padding: 10px; text-align: center; color: #5a7a90;">No events</div>
    </div>
  </section>
</div>

<!-- ROW 3: COMMANDS -->
<div class="dashboard-row" style="grid-template-columns: 1fr;">
  <section class="panel">
    <h2>üîß Recent Commands</h2>
    <table style="width: 100%;">
      <thead>
        <tr><th>Time</th><th>Command</th><th>Status</th></tr>
      </thead>
      <tbody>
      {% for c in recent_commands %}
        <tr><td>{{ c.created_at|date:"H:i" }}</td>
          <td>{{ c.command|truncatewords:5 }}</td>
          <td style="text-align: center; color: #3da5d9;">{{ c.status }}</td>
        </tr>
      {% empty %}<tr><td colspan="3" style="text-align: center; color: #5a7a90; padding: 10px;">No commands</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>
</div>

<!-- MODALS -->
<div id="getStartedModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìö Get Started</h2>
      <button class="modal-close" onclick="closeGetStartedModal()">&times;</button>
    </div>
    <div class="modal-body">
      <ol><li>Add devices</li><li>Add employees</li><li>Set access levels</li><li>Assign permissions</li><li>Configure doors</li><li>Test access</li><li>Monitor logs</li><li>View reports</li></ol>
    </div>
  </div>
</div>

<div id="quickStartModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚ö° Quick Start</h2>
      <button class="modal-close" onclick="closeQuickStartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <ol><li>Discover devices</li><li>Add employee</li><li>Register biometric</li><li>Create access level</li><li>Assign access</li><li>Test door</li><li>Check logs</li><li>Generate report</li></ol>
    </div>
  </div>
</div>

<!-- Employee quick-add modal (loads the create form in an iframe) -->
<div id="employeeModal" class="modal">
  <div class="modal-content" style="width: 1200px; max-width: 1200px;">
    <button class="modal-close" onclick="closeEmployeeModal()">√ó</button>
    <div class="modal-inner">
      <div class="modal-titlebar"><div class="title"><span class="icon">+</span> Add Employee</div></div>
      <div class="modal-body" id="employeeModalBody">
        <!-- form will be loaded here via AJAX -->
      </div>
      <div class="modal-footer">
        <button id="employeeModalOk" class="primary" style="margin-right:8px;">OK</button>
        <button onclick="closeEmployeeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
function openGetStartedModal() { document.getElementById('getStartedModal').classList.add('show'); }
function closeGetStartedModal() { document.getElementById('getStartedModal').classList.remove('show'); }
function openQuickStartModal() { document.getElementById('quickStartModal').classList.add('show'); }
function closeQuickStartModal() { document.getElementById('quickStartModal').classList.remove('show'); }
function openQuickAddDevice() { console.log('Add device'); }
async function openQuickAddEmployee() {
  try{
    const url = '{% url "crud-employee-create" %}' + '?_ts=' + Date.now();
    const resp = await fetch(url, { cache: 'no-store', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
    if(!resp.ok){ console.error('Failed to fetch form', resp.status); return; }
    const data = await resp.json();
    const container = document.getElementById('employeeModalBody');
    container.innerHTML = data.html || '<div style="padding:12px;color:#900">Failed to load form</div>';
    // Execute any inline scripts returned in the fragment (innerHTML does not run them)
    const scripts = container.querySelectorAll('script');
    scripts.forEach(old => {
      const s = document.createElement('script');
      if (old.src) s.src = old.src;
      if (old.type) s.type = old.type;
      s.text = old.textContent;
      old.parentNode.replaceChild(s, old);
    });
    document.getElementById('employeeModal').classList.add('show');

    // Attach submit handler for quick form
    const form = document.getElementById('employeeQuickForm');
    if(form){
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        const status = document.getElementById('employeeQuickStatus');
        status.textContent = '‚è≥ Saving...';
        // clear previous inline errors
        container.querySelectorAll('.field-errors').forEach(d => d.textContent = '');
        const formData = new FormData(form);
        try{
          const r = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '' }, body: formData });
          const d = await r.json().catch(()=>({ ok: false, error: 'Invalid server response' }));
          if(r.ok && d.ok){
            status.textContent = '‚úì Employee created';
            setTimeout(()=>{ closeEmployeeModal(); location.reload(); }, 800);
            return;
          }
          // If validation errors returned, map them inline
          if(d && d.errors){
            applyFormErrors(container, d.errors);
            status.textContent = '‚úó Validation failed';
            return;
          }
          status.textContent = '‚úó '+(d.error || 'Validation failed');
        }catch(err){ status.textContent = '‚úó '+err.message; }
      });
    }
  }catch(e){ console.error('openQuickAddEmployee', e); }
}
// Place server-side validation errors next to fields in the injected fragment
function applyFormErrors(container, errors){
  try{
    Object.keys(errors||{}).forEach(function(field){
      const msg = errors[field] || '';
      // try to find element by id 'id_<field>'
      const el = container.querySelector('#id_' + field) || container.querySelector('[name="' + field + '"]');
      if(el){
        // find nearest .field-errors
        let fd = el.parentElement && el.parentElement.querySelector('.field-errors');
        if(!fd){
          // try ascending parents
          let p = el.parentElement;
          while(p && !fd){ fd = p.querySelector && p.querySelector('.field-errors'); p = p.parentElement; }
        }
        if(fd) fd.textContent = Array.isArray(msg) ? msg.join('; ') : msg;
      }
    });
  }catch(e){ console.error('applyFormErrors', e); }
}
function closeEmployeeModal(){ document.getElementById('employeeModal').classList.remove('show'); document.getElementById('employeeModalBody').innerHTML=''; }
function doorAction(doorId, action) { console.log('Door ' + doorId + ' - ' + action); }
window.onclick = function(event) {
  let getModal = document.getElementById('getStartedModal');
  let quickModal = document.getElementById('quickStartModal');
  let empModal = document.getElementById('employeeModal');
  if (event.target == getModal) getModal.classList.remove('show');
  if (event.target == quickModal) quickModal.classList.remove('show');
  if (event.target == empModal) closeEmployeeModal();
}
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('wsConnStatus').innerText = '‚úì Connected';
});
// Modal-level OK button should trigger the inner quick form submit when present
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'employeeModalOk'){
    const form = document.getElementById('employeeQuickForm');
    if(form){
      if(typeof form.requestSubmit === 'function') form.requestSubmit(); else form.submit();
    }
  }
});
</script>

{% endblock %}
