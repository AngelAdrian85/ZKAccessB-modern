{% extends 'agent/base_legacy.html' %}
{% block title %}Employees CRUD{% endblock %}
{% block content %}
<h2 style="color: #3da5d9; padding-bottom: 10px;">ðŸ‘¥ Employees Management</h2>
<p style="margin-top: 10px;">
  <a class='op' data-tip='AdaugÄƒ un angajat nou' href='{% url "crud-employee-create" %}' style="background: #3da5d9; color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none;">+ Add Employee</a> |
  <a class='op' data-tip='ImportÄƒ mai mulÈ›i angajaÈ›i dintr-un fiÈ™ier' href='{% url "crud-employee-import" %}' style="background: #3da5d9; color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none;">â¬† Bulk Import</a> |
  <a class='op' data-tip='ExportÄƒ lista Ã®n format CSV' href='{% url "crud-employee-export" %}?format=csv' style="background: #3da5d9; color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none;">â¬‡ Export CSV</a>
</p>
<table class='status-box' style='width:100%;border-collapse:collapse;background:#2d5a7b;border:1px solid #3d6a8b;'>
<tr style="background: linear-gradient(90deg, #1a3a52 0%, #3da5d9 100%); color: #fff; font-weight: 600;"><th style="padding:10px;border:1px solid #3d6a8b;">First</th><th style="padding:10px;border:1px solid #3d6a8b;">Last</th><th style="padding:10px;border:1px solid #3d6a8b;">Card</th><th style="padding:10px;border:1px solid #3d6a8b;">Levels</th><th style="padding:10px;border:1px solid #3d6a8b;">Active</th><th style="padding:10px;border:1px solid #3d6a8b;">Actions</th></tr>
{% for e in employees %}
<tr data-emp-id='{{ e.id }}' style="border-bottom: 1px solid #3d6a8b; background: #2d5a7b; color: #e8f0f8;">
  <td class='inline-edit' data-field='first_name' style="padding: 8px; border-right: 1px solid #3d6a8b;">{{ e.first_name }}</td>
  <td class='inline-edit' data-field='last_name' style="padding: 8px; border-right: 1px solid #3d6a8b;">{{ e.last_name }}</td>
  <td class='inline-edit' data-field='card_number' style="padding: 8px; border-right: 1px solid #3d6a8b;">{{ e.card_number }}</td>
  <td style="padding: 8px; border-right: 1px solid #3d6a8b;">{{ e.access_levels.all|join:", " }}</td>
  <td class='inline-edit' data-field='active' style="padding: 8px; border-right: 1px solid #3d6a8b;">{{ e.active }}</td>
  <td style="padding: 8px;"><a class='op' data-tip='EditeazÄƒ acest angajat' href='{% url "crud-employee-edit" e.id %}' style="background: #3da5d9; color: #fff; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 12px;">Edit</a>
    <form method='post' action='{% url "crud-employee-delete" e.id %}' style='display:inline' onsubmit='return confirm("Delete employee?")' title='È˜terge definitiv angajatul'>
      {% csrf_token %}<button class='op' data-tip='È˜terge angajatul' style='background:#d97e4a; color: #fff; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;'>Del</button>
    </form>
    <input type='number' min='1' placeholder='Door ID' class='door-check-input' style='width:70px;padding:4px;border:1px solid #3d6a8b;border-radius:3px;background:#1a3a52;color:#e8f0f8;'>
    <button type='button' class='op check-access-btn' data-tip='VerificÄƒ dacÄƒ angajatul are acces la uÈ™a indicatÄƒ' style="background: #2da44e; color: #fff; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Check</button>
    <span class='access-indicator' style='margin-left:4px;font-weight:bold;color:#3da5d9'></span>
  </td>
</tr>
{% empty %}<tr><td colspan='6' style="padding: 10px; text-align: center; color: #5a7a90;">No employees</td></tr>{% endfor %}
</table>
{% endblock %}
{% block extra_js %}
<script>
function getCSRF(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
document.querySelectorAll('td.inline-edit').forEach(td=>{
  document.querySelectorAll('.check-access-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const tr = btn.closest('tr');
      const empId = tr.getAttribute('data-emp-id');
      const doorId = tr.querySelector('.door-check-input').value.trim();
      const indicator = tr.querySelector('.access-indicator');
      if(!doorId){ indicator.textContent='Door?'; indicator.style.color='#e09'; return; }
      indicator.textContent='...'; indicator.style.color='#999';
      fetch(`/agent/api/access/check/?employee=${empId}&door=${doorId}`)
        .then(r=>r.json()).then(d=>{
          if(!d.ok){ indicator.textContent='ERR'; indicator.style.color='#e00'; return; }
          indicator.textContent= d.allowed ? 'ALLOW' : 'DENY';
          indicator.style.color = d.allowed ? '#0c4' : '#d33';
          indicator.title = d.reason + (d.cached? ' (cached)':'');
        }).catch(()=>{ indicator.textContent='ERR'; indicator.style.color='#e00'; });
    });
  });
  td.contentEditable=true;
  td.addEventListener('blur',()=>{
    const tr=td.closest('tr'); const id=tr.getAttribute('data-emp-id'); const field=td.getAttribute('data-field');
    let value=td.innerText.trim(); if(field==='active'){ value=(value.toLowerCase().startsWith('t')||value==='1'); }
    fetch(`/agent/crud/employees/${id}/inline/`, {method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()}, body:JSON.stringify({field,value})})
      .then(r=>r.json()).then(d=>{ if(!d.ok){ console.warn('Inline update failed', d); }});
  });
});
</script>
{% endblock %}
