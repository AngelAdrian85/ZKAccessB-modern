{% extends 'agent/base_legacy.html' %}
{% block title %}Doors List{% endblock %}
{% block content %}
<h2 style="background: linear-gradient(135deg, #0a4a8c 0%, #1e7bc9 50%, #87ceeb 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; padding-bottom: 10px;">ðŸšª Doors (CRUD)</h2>
<p style="margin-top: 10px;"><a class='op' href='{% url "crud-door-create" %}' style="background: linear-gradient(135deg, #0a4a8c 0%, #1e7bc9 50%, #87ceeb 100%); color: #fff; padding: 6px 12px; border-radius: 4px; text-decoration: none;">Add Door</a></p>
<table class='status-box' style='width:100%;border-collapse:collapse;background:#fff;border:1px solid #c5d3e3;'>
<tr style="background: linear-gradient(135deg, #0a4a8c 0%, #1e7bc9 50%, #87ceeb 100%); color: #fff; font-weight: 600;"><th style="padding:10px;border:1px solid #87ceeb;">Name</th><th style="padding:10px;border:1px solid #87ceeb;">Device</th><th style="padding:10px;border:1px solid #87ceeb;">Location</th><th style="padding:10px;border:1px solid #87ceeb;">Enabled</th><th style="padding:10px;border:1px solid #87ceeb;">State</th><th style="padding:10px;border:1px solid #87ceeb;">Actions</th></tr>
{% for d in page.object_list %}
<tr data-door-id='{{ d.id }}' style="border-bottom: 1px solid #e0e6f2; background: #fff;">
  <td class='inline-edit' data-field='name' style="padding: 8px; border-right: 1px solid #e0e6f2;">{{ d.name }}</td>
  <td style="padding: 8px; border-right: 1px solid #e0e6f2;">{{ d.device }}</td>
  <td class='inline-edit' data-field='location' style="padding: 8px; border-right: 1px solid #e0e6f2;">{{ d.location }}</td>
  <td class='inline-edit' data-field='enabled' style="padding: 8px; border-right: 1px solid #e0e6f2;">{{ d.enabled }}</td>
  <td class='door-state' style="padding: 8px; border-right: 1px solid #e0e6f2;"><span style="color: {% if d.is_open %}#da3633{% else %}#2da44e{% endif %}; font-weight: 600;">{{ d.is_open|yesno:"OPEN,CLOSED" }}</span></td>
  <td style="padding: 8px;">
    <a class='op' href='{% url "crud-door-edit" d.id %}' style="background: #2da44e; color: #fff; padding: 4px 8px; border-radius: 3px; text-decoration: none; font-size: 12px;">Edit</a>
    {% if d.device %}
      <button class='op door-open-btn' style="background: #1e7bc9; color: #fff; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Open</button>
      <button class='op door-close-btn' style='background:#999; color: #fff; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;'>Close</button>
    {% endif %}
    <form method='post' action='{% url "crud-door-delete" d.id %}' style='display:inline' onsubmit='return confirm("Delete door?")'>
      {% csrf_token %}<button class='op' style='background:#da3633; color: #fff; padding: 4px 8px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;'>Del</button>
    </form>
  </td>
</tr>
{% empty %}<tr><td colspan='6' style="padding: 10px; text-align: center; color: #999;">No doors</td></tr>{% endfor %}
</table>
<div>Page {{ page.number }} of {{ page.paginator.num_pages }}</div>
{% if page.has_previous %}<a href='?page={{ page.previous_page_number }}'>Prev</a>{% endif %}
{% if page.has_next %}<a href='?page={{ page.next_page_number }}'>Next</a>{% endif %}
{% endblock %}
{% block extra_js %}
<script>
function getCSRF(){
  const m = document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:'';
}
document.querySelectorAll('td.inline-edit').forEach(td=>{
  td.contentEditable = true;
  td.addEventListener('blur', ()=>{
    const tr = td.closest('tr');
    const id = tr.getAttribute('data-door-id');
    const field = td.getAttribute('data-field');
    let value = td.innerText.trim();
    if(field==='enabled'){ value = (value.toLowerCase().startsWith('t')||value==='1'||value.toLowerCase()==='true'); }
    fetch(`/agent/crud/doors/${id}/inline/`, {
      method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},
      body: JSON.stringify({field, value})
    }).then(r=>r.json()).then(data=>{ if(!data.ok){ console.warn(data); } });
  });
});
document.querySelectorAll('.door-open-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id = btn.closest('tr').getAttribute('data-door-id');
    fetch(`/agent/api/doors/${id}/open/`).then(r=>r.json()).then(data=>{ if(data.ok){ btn.closest('tr').querySelector('.door-state').innerText='OPEN'; } });
  });
});
document.querySelectorAll('.door-close-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id = btn.closest('tr').getAttribute('data-door-id');
    fetch(`/agent/api/doors/${id}/close/`).then(r=>r.json()).then(data=>{ if(data.ok){ btn.closest('tr').querySelector('.door-state').innerText='CLOSED'; } });
  });
});
</script>
{% endblock %}