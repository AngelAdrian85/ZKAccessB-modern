{% extends 'base.html' %}

{% block content %}
<h1>Access Logs</h1>
<form method="get">
  <input type="text" name="q" placeholder="userid or cardno" value="{{ filters.q }}" />
  <input type="text" name="door" placeholder="door id" value="{{ filters.door }}" />
  <label>Device:
    <select name="device">
      <option value="">-- any --</option>
      {% for d in devices %}
      <option value="{{ d.id }}" {% if filters.device and filters.device|stringformat:"s" == d.id|stringformat:"s" %}selected{% endif %}>{{ d.name }}</option>
      {% endfor %}
    </select>
  </label>
  <label>Event:
    <select name="event_type">
      <option value="">-- any --</option>
      {% for et in event_types %}
      <option value="{{ et }}" {% if filters.event_type == et %}selected{% endif %}>{{ et }}</option>
      {% endfor %}
    </select>
  </label>
  <input type="text" name="start" placeholder="YYYY-MM-DDTHH:MM" value="{{ filters.start }}" />
  <input type="text" name="end" placeholder="YYYY-MM-DDTHH:MM" value="{{ filters.end }}" />
  <button type="submit">Filter</button>
  <a href="?{% if filters.q %}q={{ filters.q }}&{% endif %}{% if filters.door %}door={{ filters.door }}&{% endif %}{% if filters.start %}start={{ filters.start }}&{% endif %}{% if filters.end %}end={{ filters.end }}&{% endif %}export=csv">Export CSV</a>
</form>

<table>
  <thead>
    <tr>
      <th>Time</th>
      <th>UserID</th>
      <th>Card</th>
      <th>Door</th>
      <th>Device</th>
      <th>Event</th>
      <th>Result</th>
      <th>Info</th>
    </tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td>{{ log.timestamp }}</td>
  <td>{% if log.userid %}{{ log.userid.userid }}{% endif %}</td>
      <td>{{ log.cardno }}</td>
  <td>{% if log.door %}{{ log.door.name }}{% endif %}</td>
  <td>{% if log.device %}{{ log.device.device_name }}{% endif %}</td>
      <td>{{ log.event_type }}</td>
      <td>{{ log.result }}</td>
      <td>{{ log.info }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="8">No logs found</td></tr>
    {% endfor %}
  </tbody>
</table>

{% if paginator.num_pages > 1 %}
  <div class="pagination">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}">previous</a>
    {% endif %}
    <span>Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">next</a>
    {% endif %}
  </div>
{% endif %}

{% endblock %}
